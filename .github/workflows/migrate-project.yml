name: Migrate GitHub Project to Org (copy + items)

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.MIGRATION_PAT }}

    steps:
      - name: Show gh version
        run: gh --version

      - name: Sanity check: show source items count
        run: |
          set -euo pipefail
          gh project item-list 4 --owner LevShlyogin -L 2000 --format json \
            | jq '.items | length'

      - name: Copy project user -> org (structure + drafts)
        id: copy
        run: |
          set -euo pipefail
          NEW_NUM=$(gh project copy 4 \
            --source-owner LevShlyogin \
            --target-owner SKB-CADDep \
            --title "Project #4 (org copy)" \
            --drafts \
            --format json \
            --jq '.number')
          echo "new_num=$NEW_NUM" >> "$GITHUB_OUTPUT"
          echo "New org project number: $NEW_NUM"

      - name: Add all Issue/PR items from old project into new org project
        run: |
          set -euo pipefail

          NEW_NUM='${{ steps.copy.outputs.new_num }}'

          gh project item-list 4 --owner LevShlyogin -L 2000 --format json \
            | jq -r '.items[]
              | select(.content.type == "Issue" or .content.type == "PullRequest")
              | .content.url' \
            | while IFS= read -r url; do
                [ -z "$url" ] && continue
                echo "Adding $url"
                # если вдруг уже добавлено или нет доступа — не валим весь job:
                gh project item-add "$NEW_NUM" --owner SKB-CADDep --url "$url" || true
              done

      - name: Compare item counts (after)
        run: |
          set -euo pipefail
          SRC=$(gh project item-list 4 --owner LevShlyogin -L 2000 --format json | jq '.items | length')
          DST=$(gh project item-list '${{ steps.copy.outputs.new_num }}' --owner SKB-CADDep -L 2000 --format json | jq '.items | length')
          echo "Source items: $SRC"
          echo "Dest items:   $DST"
