name: Migrate GitHub Project to Org (Full)

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  migrate:
    runs-on: ubuntu-latest
    permissions:
      projects: write  # –î–ª—è gh project
      contents: write  # Repo
      issues: read     # Items
      pull-requests: read
    env:
      GH_TOKEN: ${{ secrets.MIGRATION_PAT }}  # Fine-grained PAT: projects:full, repo:full, org:write
    steps:
      - name: Checkout repo (for logs)
        uses: actions/checkout@v4

      - name: Verify auth & scopes
        run: |
          gh auth status
          echo "User: $(gh api user --jq .login)"
          echo "Org access: $(gh api orgs/SKB-CADDep --jq .name || echo 'No access')"

      - name: 1. Copy project structure (user -> org)
        id: copy
        run: |
          SRC_NUM=4
          SRC_OWNER=LevShlyogin
          DST_OWNER=SKB-CADDep
          NEW_TITLE="–î–≤–∏–∂—É—Ö–∞ –≥—Ä—É–ø–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ü–û (org copy)"
          
          NEW_NUM=$(gh project copy $SRC_NUM \
            --source-owner $SRC_OWNER \
            --target-owner $DST_OWNER \
            --title "$NEW_TITLE" \
            --drafts \
            --format json \
            --jq '.number')
          echo "new_num=$NEW_NUM" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Structure copied: https://github.com/orgs/$DST_OWNER/projects/$NEW_NUM"

      - name: 2. Bulk add ALL items from source (fix empty!)
        run: |
          SRC_NUM=4
          NEW_NUM=${{ steps.copy.outputs.new_num }}
          SRC_OWNER=LevShlyogin
          DST_OWNER=SKB-CADDep
          
          echo "üì• Fetching source item URLs (max 1000)..."
          gh project item-list $SRC_NUM --owner $SRC_OWNER -L 1000 --format json \
            --jq '.[].content.url? // empty' \
            | grep -v '^$' \
            | while read -r url; do
                echo "‚ûï Adding: $url"
                gh project item-add $NEW_NUM --owner $DST_OWNER --url "$url" || echo "‚ö†Ô∏è Skipped (dup/error): $url"
                sleep 0.5  # Rate limit safety
              done
          echo "‚úÖ Bulk items added!"

      - name: 3. Sanity check counts
        run: |
          SRC_NUM=4
          NEW_NUM=${{ steps.copy.outputs.new_num }}
          SRC_COUNT=$(gh project item-list $SRC_NUM --owner LevShlyogin -L 2000 --format json --jq 'length')
          DST_COUNT=$(gh project item-list $NEW_NUM --owner SKB-CADDep -L 2000 --format json --jq 'length')
          echo "üìä Source items: $SRC_COUNT"
          echo "üìä Dest items:   $DST_COUNT"
